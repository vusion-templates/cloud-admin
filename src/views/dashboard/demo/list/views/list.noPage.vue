<template>
    <div>
        <u-page-sum>
            常见的列表页(无分页)
        </u-page-sum>
        <div class="page-action">
            <u-linear-layout display="inline">
                <u-button icon="create" color="primary" @click="createItem">创建实例(方法)</u-button>
                <u-button icon="create" color="primary" to="/demo/create">创建实例(路由)</u-button>
                <u-button square icon="refresh" @click="refresh"></u-button>
            </u-linear-layout>
            <u-linear-layout class="page-action-right">
                <u-search v-model="form.search" placeholder="搜索"></u-search>
            </u-linear-layout>
        </div>
        <u-table-view :data="list" :loading="loading" value-field="name" :values="selected">
            <u-table-view-column type="checkbox" width="8%"></u-table-view-column>
            <u-table-view-column title="消息标题">
                <template slot="cell" slot-scope="{ item }">
                    <img :src="item.thumb" alt="" height="40"> {{ item.name }}
                </template>
            </u-table-view-column>
            <u-table-view-column title="时间">
                <template slot="cell" slot-scope="{ item }">
                    {{ item.time | dateFormat }}
                </template>
            </u-table-view-column>
            <u-table-view-column title="操作">
                <template slot="cell" slot-scope="scope">
                    <u-linear-layout>
                        <u-link :to="{name: 'demo.detail', query: {id: scope.item.ch_name}}">
                            查看详情
                        </u-link>
                        <u-link @click="deleteItem">
                            删除
                        </u-link>
                    </u-linear-layout>
                </template>
            </u-table-view-column>
        </u-table-view>
        <u-footbar :position="batchBtnPos">
            <u-linear-layout>
                <span>已选择 {{ selected.length }} 条</span>
                <u-button :disabled="!allowBatchDelete" @click="batchDelete">删除</u-button>
            </u-linear-layout>
        </u-footbar>
    </div>
</template>
<script>
import page from '@/global/mixins/page/page';
import messageService from '../services/index';
export default {
    mixins: [page],
    data() {
        return {
            selected: [],
            form: {
                search: '',
            },
        };
    },
    computed: {
        allowBatchDelete() {
            return this.selected && this.selected.length;
        },
        batchBtnPos() {
            const pos = this.selected && this.selected.length > 0 ? 'auto' : 'static';
            return pos;
        },
    },
    watch: {
        list() {
            this.selected = [];
        },
        'form.search'() {
            this.reset();
            this.refresh();
        },
    },
    methods: {
        loadList() {
            return messageService.list({
                query: {
                    search: this.form.search,
                },
            }).then((res) => {
                let result = [];
                res.data.result.forEach((item) => {
                    item.channellist.forEach((channel) => {
                        channel.thumb = channel.thumb || channel.avatar;
                        channel.time = new Date() - 0;
                        channel.cate_sname = channel.cate_sname || item.title;
                    });
                    result.push(...item.channellist);
                });
                if (this.form.search) {
                    result = result.filter((item) => JSON.stringify(item).includes(this.form.search));
                }
                this.list = result;
            });
        },
        batchDelete() {
            this.$confirm(`确认删除 ${this.selected.join(',')} 实例吗？`, '删除确认').then(() => {
                this.refresh();
            }, () => {
                console.log('取消删除');
            });
        },
        createItem() {
            this.$toast.show('创建实例');
        },
        deleteItem() {
            this.$confirm('确认删除该实例吗？', '确认删除').then(() => {
                this.$toast.show('开始删除');
            }, () => {
                this.$toast.show('取消删除');
            });
        },
    },
};
</script>
<style module>

</style>
